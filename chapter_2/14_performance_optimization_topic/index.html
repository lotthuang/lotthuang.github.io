<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>第十四篇 性能调优 - Lott's Blog</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u7b2c\u5341\u56db\u7bc7 \u6027\u80fd\u8c03\u4f18";
        var mkdocs_page_input_path = "chapter_2/14_performance_optimization_topic.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Lott's Blog
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">第一章 各种杂项基础</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/1_make_blog/">第一篇 利用Github Pages和mkdocs搭建个人博客</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/2_nginx_loadbalancing_strategy/">第二篇 Nginx的均衡策略</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/3_linux_kernel_basic/">第三篇 Linux内核基础</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/4_linux_kernel_mm_basic/">第四篇 Linux内核空间内存概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/5_how_kernel_call_bios/">第五篇 Linux内核调用BIOS案例</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/9_linux_arch_overall_introduction/">第九篇 Linux架构整体介绍</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/10_virtual_machine_on_mac_m1_chip/">第十篇 Mac M1芯片电脑利用Qemu安装Debian虚拟机</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/11_nftables/">第十一篇 Debian 11以及往后版本nftables防火墙配置</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/12_ansible_basic_use/">第十二篇 Ansible简单使用笔记</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/13_tty_terminal_console/">第十三篇 终端(Terminal)、TTY、PTY和控制台(Console)区别</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/14_qemu_use/">第十四篇 QEMU模拟各类开发板</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/15_bosun/">第十五篇 Bosun使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/16_assembler/">第十六篇 汇编语言使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/17_makefile/">第十七篇 Makefile使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/19_network_ratelimit/">第十九篇 Linux网络限速</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/20_mac_os_skills/">第二十篇 MacOS使用技巧</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/21_debian_skills/">第二十一篇 Debian使用技巧</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/22_initrd_initramfs/">第二十二篇 initrd和initramfs</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第二章 运维工作总结</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../yunweijiazhi/">第一篇 运维的价值和目标</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../yunweizhiyeguifan/">第二篇 业务SRE的职业规范</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../yunweipingtailinian/">第三篇 运维平台建设的理念</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guzhangguanli/">第四篇 故障管理概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../biangengguanli/">第五篇 变更管理概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../rongliangguanli/">第六篇 容量管理概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../jiagoushisiweihetezhi/">第七篇 架构师思维和特质以及中间件技术梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cicd/">第八篇 CICD流程概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../9_changkanchangxin/">第九篇 常看常新</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../12_monitor_and_alert/">第十二篇 监控报警最佳实践</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../13_classic_thinkings/">第十三篇 经典思维</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">第十四篇 性能调优</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_2">系统级性能优化</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#perf">Perf 工具概念</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_3">实践</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_4">其一 追踪某个进程在哪个系统调用上消耗时间最多</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_5">其二 生成火焰图</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#negative-dentry">其三 关于 negative dentry</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_6">其四</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#linux">二 Linux通用内核参数优化</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1">1 网络相关内核参数</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2">2 内存</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3">3 文件系统</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4-io">4 硬盘IO</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#5">5 网卡数据链路层</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#6">6  网络服务优化</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../15_secure_sre/">第十五篇 安全运维</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../16_yunweijiazhi/">第十六篇 公司视角下运维的价值</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../17_cdn_sre/">第十七篇 CDN运维</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第三章 Linux Net子系统</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/1_linux_kernel_net/">第一篇 Linux数据包接收路径梳理和常用调优技能</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/2_estab_queue_monitoring/">第二篇 Linux下如何观察完整连接队列的情况</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/3_net_ipv4_tcp_syn_retries/">第三篇 理解net.ipv4.tcp_syn_retries设置</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/4_linux_kernel_net_v2/">第四篇 Linux网络数据包的揭秘以及常见的调优方式总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/5_conntrack/">第五篇 conntrack的常见应用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/6_tcp/">第六篇 TCP协议总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/7_udp/">第七篇 UDP协议总结以及TCP和UDP的区别</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/8_io_multiplexing/">第八篇 IO多路复用总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/10_linux_net/">第十篇 Linux Net子系统总结、收发包流程再次梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/11_igb/">第十一篇 igb网卡驱动梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/12_rss_rps_rfs_xps/">第十二篇 Linux网卡rss和rps和rfs和xps</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/13_linghunkaowen/">第十三篇 Linux网络子系统灵魂拷问</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第四章 Linux CPU子系统</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/1_process_ulimit/">第一篇 进程Max open files的设置</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/2_pid_max/">第二篇 kernel源码中pid的最大值</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/3_interrupt_one/">第三篇 硬中断</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/5_soft_irq/">第四篇 软中断</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/4_process_thread_coroutine/">第五篇 进程、线程、协程</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/6_cpu_famous_register/">第六篇 CPU中的著名寄存器梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/7_linux_signal/">第七篇 Linux信号机制</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/8_linux_scheduler/">第八篇 Linux进程调度</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/10_linux_context_switch/">第十篇 低视角看context switch</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/11_linux_cpu_usage/">第十一篇 CPU利用率统计</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/12_linux_preemption/">第十二篇 内核抢占基础篇</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/13_interrupt_handler_examples/">第十三篇 中断处理程序的例子</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/14_linux_kernel_tracing/">第十四篇 理解内核追踪机制</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/15_task_struct/">第十五篇 task_struct结构体总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/16_init_call/">第十六篇 Linux各类initcall总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/17_coredump/">第十七篇 Linux coredump总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/18_cpu_CacheLine/">第十八篇 CPU CacheLine总结</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第五章 Linux IO子系统</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_5/1_four_object_of_VFS/">第一篇 VFS四大对象inode、dentry、super_block、file数据结构总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_5/2_io_stack/">第二篇 Linux IO栈总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_5/3_zero_copy/">第三篇 Linux 零拷贝技术总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_5/4_io_scheduler_layer/">第四篇 Block IO Layer(块IO层)总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_5/6_fss/">第六篇 各类文件系统梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_5/7_three_object_of_block_device/">第七篇 块设备三大对象block_device、gendisk、hd_struct数据结构总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_5/8_kobjet_kset_ktype/">第八篇 Linux设备模型的基石:kset/kobject/ktype</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_5/9_io_uring/">第九篇 io_uring研究和总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_5/10_device_database/">第十篇 设备数据库</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_5/11_io_uring_again/">第十一篇 io_uring起源</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第六章 Linux Mem子系统</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/1_linux_buddy/">第一篇 伙伴系统介绍</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/2_slab/">第二篇 Slab层介绍</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/3_virtual_memory/">第三篇 进程虚拟地址空间介绍</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/4_linux_mem_theory/">第四篇 Linux内存管理基础篇</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/6_alloc_mem_apis/">第六篇 Linux内核内存分配API函数分类</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/7_physical_memory/">第七篇 关于物理内存管理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/8_linux_mm_update/">第八篇 Linux内存管理升级篇</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/9_page_cache_and_buffer_cache/">第九篇 PageCache和BufferCache演进过程</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第七章 运维小技巧和工具汇总和积累</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/1_sync_file/">第一篇 不同主机之间的文件传输</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/2_sre_tools_python/">第二篇 运维生产力工具(python篇)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/3_sre_tools_website/">第三篇 运维生产力工具(网站工具)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/4_sre_tools_shell/">第四篇 运维生产力工具(shell篇)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/5_server_side_evolution/">第五篇 服务端进化过程梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/7_charset/">第七篇 字符集和编码</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/8_locale/">第八篇 locale设置</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/9_http_protocol/">第九篇 http协议</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/10_http_cookie_session_token/">第十篇 cookie和session和token总结</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第八章 职场通用经验</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/1_xuexixinde/">第一篇 学习心得和工作箴言</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/2_bangzhuqitatongxue/">第二篇 工作能力评价体系</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/3_yewuliuchengshuyu/">第三篇 项目管理总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/4_jishunenglimoxing/">第四篇 技术能力模型总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/5_chanpingsiwei_1/">第五篇 产品思维总结和梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/6_jixiaobaogao/">第六篇 如何写绩效报告</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/7_xiangshangguanli/">第七篇 如何向上管理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/9_speaking_skills/">第九篇 沟通能力和演讲技巧</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/10_jixiaofangtan/">第十篇 绩效访谈总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/11_classic_technical_thinking/">第十一篇 经典技术思维汇总</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/12_manager_thinking/">第十二篇 管理</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第九章 编程经验和各类开源软件</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/1_suanfa/">第一篇 算法总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/2_data_structure/">第二篇 数据结构总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/3_c_lang/">第三篇 c语言总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/4_symbol_table/">第四篇 符号表总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/5_golang/">第五篇 go语言总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/6_linux_kernel_patch/">第六篇 手把手教你向Linux Kernel提交Patch</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/7_python/">第七篇 python语言总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/8_rsyslog/">第八篇 rsyslog</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/9_falcon/">第九篇 falcon和夜莺</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/10_json_schema/">第十篇 JSON-Schema使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/11_prometheus/">第十一篇 Prometheus使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/12_grafana/">第十二篇 Grafana使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/13_mysql/">第十三篇 MySQL使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/14_mongodb/">第十四篇 MongoDB使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/15_supervisor/">第十五篇 Supervisor使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/16_redis/">第十六篇 Redis使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/17_mongodb_2/">第十七篇 MongoDB基础</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/18_elk_2/">第十八篇 ELK基础</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/19_gitlab_ce/">第十九篇 Gitlab-CE维护</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/20_minio/">第二十篇 MinIO维护</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/21_elk_1/">第二十一篇 ELK维护</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/22_httpdns/">第二十二篇 HTTPDNS梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/23_ssl_certs/">第二十三篇 SSL证书总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/24_p4/">第二十四篇 P4服务器梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/25_fastapi/">第二十五篇 FastAPI梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/26_vue.js/">第二十六篇 Vue.js梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/27_html_basic/">第二十七篇 HTML基础梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/28_typescript/">第二十八篇 TypeScript梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/29_mdadm/">第二十九篇 mdadm工具详解</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十章 容器化和Kubernetes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/1_dockerfile_best_practice/">第一篇 dockerfile最佳实践</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/2_benefits_of_containerization/">第二篇 容器化好处</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/3_docker_basic_concepts/">第三篇 容器化基础概念</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/4_kubernetes_basic_concepts/">第四篇 Kubernetes基础概念</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/6_production_kubernetes_best_practice/">第六篇 生产环境Kubernetes部署最佳实践</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/7_production_kerbernetes_yaml/">第七篇 生产环境Kubernetes YAML模版</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/8_Calico/">第八篇 Kubernetes网络插件之Calico</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/9_cloudnative_monitor/">第九篇 云原生监控</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/10_event/">第十篇 彻底搞懂Kubernetes Event</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/11_best_practices/">第十一篇 Kubernetes最佳实践</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/12_cloud_network/">第十二篇 云网络</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/13_containerd/">第十三篇 Containerd</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/14_k8s_and_gpu/">第十四篇 基于K8S管理GPU集群</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/15_public_cloud_use/">第十五篇 公有云最佳实践总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/16_podman/">第十六篇 Podman总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/17_tke/">第十七篇 腾讯云TKE总结</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十一章 SRE稳定性建设从理论到实践</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_11/1_theory/">第一篇 稳定性概论</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_11/10_high_avaliable/">第二篇 高可用原则总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_11/2_slo_process/">第三篇 SLO实施流程</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_11/3_stress/">第四篇 压测经验总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_11/11_stability/">第五篇 稳定性理论总结</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十二章 商业化知识总结</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_12/1_shifouzhide/">第一篇 如何判断一件事情值不值得做</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十三章 芯片知识总结</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_13/1_about_riscv/">第一篇 RISC-V 简介</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_13/2_danpianji/">第二篇 单片机简介</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十四章 Linux驱动方向总结</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/1_demo_of_led_driver/">第一篇 驱动程序的Hello World</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/2_qianrushidev/">第二篇 嵌入式开发基础</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/3_linux_kernel_api_list/">第三篇 Linux内核API汇总和各类风格总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/4_zifushebeiqudongyuanli/">第四篇 字符设备驱动实现原理和物理内存地址空间和IO端口空间</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/5_device_tree/">第五篇 platform总线模型和设备树</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/6_device_driver_sop/">第六篇 从阅读硬件手册开始设备驱动程序编写</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/7_linux_kernel_clipping/">第七篇 Linux移植</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/8_linux_driver_framework/">第八篇 Linux驱动框架和SoC驱动框架</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/9_linux_device_class/">第九篇 Linux设备分类</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/10_u_boot/">第十篇 u-boot梳理和总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/11_linux_reset_subsystem_and_framework/">第十一篇 Linux Reset子系统及其框架</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/12_pinctl_and_gpio/">第十二篇 Linux pinctl和gpio子系统及其框架</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/13_embedded_development_direction/">第十三篇 嵌入式开发方向和分类</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/14_linux_kernel_trimming/">第十四篇 Linux内核裁剪总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/15_imx6ull/">第十五篇 IMX6UL实验记录</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十五章 AI+嵌入式结合方向汇总</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_15/1_basic_of_ai/">第一篇 AI入门</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_15/2_nvidia_gpu/">第二篇 英伟达GPU产品分类</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_15/3_basic_of_mcp/">第三篇 MCP入门</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十六章 网络安全方向</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_16/1_network_attack/">第一篇 认识各种网络攻击</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_16/2_industry_breakdown/">第二篇 行业故障梳理</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Lott's Blog</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>第二章 运维工作总结 &raquo;</li>
      <li>第十四篇 性能调优</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">概述</h1>
<ul>
<li>本篇总结性能优化方向的案例和经验</li>
</ul>
<h2 id="_2">系统级性能优化</h2>
<p>系统级性能优化是指为了提高应用程序对操作系统资源与硬件资源的使用效率，或者为了提高操作系统对硬件资源的使用效率而进行的代码优化。</p>
<p>通过提高对操作系统资源与硬件资源的利用率，使得应用程序与基础软硬件平台具有更好的交互性，往往可以显著提升应用程序的执行速度和稳定性。</p>
<p>系统级性能优化 通常包括 2 个阶段，分别是<strong>性能剖析(performance profiling)</strong>和<strong>代码优化</strong>。</p>
<ul>
<li><strong>性能剖析阶段</strong>的目标是寻找性能瓶颈，查找引发性能问题的原因及热点代码。</li>
<li><strong>代码优化阶段</strong>的目标是针对具体的性能问题而优化代码与编译选项，以改善软件性能。</li>
</ul>
<h2 id="perf">Perf 工具概念</h2>
<ul>
<li>
<p>perf 是内置与 Linux 内核源码树中的性能剖析工具。基于事件采样原理，以性能事件为基础，支持针对处理器相关性能指标和操作系统相关性能指标的性能剖析。<strong>可用于性能瓶颈的查找与热点代码的定位。</strong></p>
</li>
<li>
<p>系统级性能优化分为两个阶段：性能剖析和代码优化。</p>
</li>
</ul>
<h2 id="_3">实践</h2>
<h3 id="_4">其一 追踪某个进程在哪个系统调用上消耗时间最多</h3>
<ul>
<li>
<p>适用于已经怀疑某个进程是造成操作系统瓶颈的基础上</p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s/H77vlf4MEVD-BL9spgiMYw">追踪 systemd 进程最耗时的系统调用</a></p>
</li>
</ul>
<p>systemd 有超过 1 秒多的时间消耗在了 inotify_add_watch 的系统调用上。</p>
<pre><code>strace -f -c -p 1       抓取10秒以后ctrl+c  退出
</code></pre>
<p><img alt="png" src="../../img/WechatIMG601.jpg" /></p>
<h3 id="_5">其二 生成火焰图</h3>
<ul>
<li>
<p>根据 perf 得到的数据生成 CPU 火焰图。</p>
</li>
<li>
<p><code>perf record -F 99 -p 1 -g -- sleep 30</code></p>
</li>
<li>
<ul>
<li>pid 表示需要采样的进程 id，如果是 Java 进程可以使用 jps 等命令获取进程 id，</li>
</ul>
</li>
<li>
<ul>
<li>perf record 表示记录，-F 99 表示每秒 99 次，-g 表示记录调用栈，sleep 30 则是持续 30 秒</li>
</ul>
</li>
<li>
<p>使用 perf script 工具对 perf.data 进行解析</p>
</li>
</ul>
<pre><code>perf script -i perf.data &amp;&gt; perf.unfold
</code></pre>
<ul>
<li>需要用到一个国外大神 bredangregg 自己写的性能分析工具火焰图，项目地址：https://github.com/brendangregg/FlameGraph</li>
</ul>
<pre><code>


./stackcollapse-perf.pl perf.unfold &gt; perf.folded //生成折叠后的调用栈
./flamegraph.pl perf.folded &gt; out.svg //生成火焰图

从火焰图上可以清晰地看出，CPU的主要耗时集中在__fsnotify_update_child_dentry_flags函数上。在最热点的函数里的调用链为inotify_add_watch-&gt;fsnotify_add_mark_locked-&gt;fsnotify-recalc_mast-&gt;__fsnotify_update_child_dentry_flags。最终指向了函数__fsnotify_update_child_dentry_flags

</code></pre>
<h3 id="negative-dentry">其三 关于 negative dentry</h3>
<ul>
<li>如果一个 dentry 没有对应的 inode，那它就是 negative 的。</li>
</ul>
<h3 id="_6">其四</h3>
<ul>
<li><code>perf top ‐p $pid</code></li>
<li>该命令利用默认的性能事件”cycles”对[code1]进行热点分析。”cycles”是处理器周期事件。这条命令能够分析出消耗处理器周期最多的代码，在处理器频率稳定的前提下，我们可以认为 perf 给出热点代码的就是消耗时间最多的代码段。</li>
</ul>
<h2 id="linux">二 Linux通用<a href="https://mp.weixin.qq.com/s/_26nGZkKA982bqnQDIJJPQ">内核参数优化</a></h2>
<ul>
<li>系统调优涵盖了多个层面，包括<strong>文件系统优化</strong>、<strong>网络性能提升</strong>、<strong>内存管理改进</strong>、<strong>CPU 调度优化</strong>以及<strong>磁盘 I/O 性能增强</strong>等。通过合理地调整这些参数，可以显著提高系统的响应速度、吞吐量，降低资源消耗，从而提升整体的运行效率。</li>
</ul>
<h3 id="1">1 网络相关内核参数</h3>
<ul>
<li>
<p>1.1 网卡RingBuffer适当调大</p>
</li>
<li>
<p>1.2 手工绑定中断到多核CPU，避免CPU0的性能瓶颈,提升系统整体性能</p>
</li>
<li>
<p>1.3 开启<code>net.ipv4.tcp_syncookies=1</code>，防范少量的tcp syn攻击.</p>
</li>
<li>
<p>1.4 增加网络缓冲区大小</p>
</li>
<li>
<ul>
<li>在高并发网络访问场景下，默认的网络缓冲区大小可能会导致数据包丢失或延迟增加。通过调整net.core.rmem_max和net.core.wmem_max参数，可以增加系统套接字接收和发送缓冲区的大小。</li>
</ul>
</li>
</ul>
<pre><code>sysctl -w net.core.rmem_max=16777216
sysctl -w net.core.wmem_max=16777216
</code></pre>
<ul>
<li>
<ul>
<li>上述命令将接收和发送缓冲区的最大值都设置为 16MB。这对于处理大量网络数据的服务器，如 Web 服务器、文件服务器等，能够有效提高数据传输的稳定性和效率。</li>
</ul>
</li>
<li>
<p>1.5 TCP全连接队列长度</p>
</li>
<li>
<ul>
<li><code>net.core.somaxconn</code>参数决定了服务器在监听新连接时，未完成三次握手的连接请求队列的最大长度。在高并发连接场景下，如果该值过小，可能会导致新的连接请求被拒绝。</li>
</ul>
</li>
</ul>
<pre><code>sysctl -w net.core.somaxconn=4096
</code></pre>
<ul>
<li>
<ul>
<li>将该值设置为 4096，可以使服务器能够处理更多的并发连接请求，避免因连接队列溢出而丢失连接。</li>
</ul>
</li>
<li>
<p>1.6 优化 TCP 拥塞控制算法</p>
</li>
<li>
<ul>
<li>Linux 系统支持多种 TCP 拥塞控制算法，如reno、cubic等。cubic算法在高带宽、长延迟网络环境下表现较为出色。通过修改net.ipv4.tcp_congestion_control参数，可以选择更适合当前网络环境的拥塞控制算法。</li>
</ul>
</li>
</ul>
<pre><code>sysctl -w net.ipv4.tcp_congestion_control=cubic
</code></pre>
<ul>
<li>
<p>1.7 减少 TIME_WAIT 状态连接数量</p>
</li>
<li>
<p>在 TCP 连接关闭时，会进入 TIME_WAIT 状态以确保最后一个 ACK 数据包被对方接收。过多的 TIME_WAIT 状态连接会占用系统资源，影响新连接的建立。通过启用<code>net.ipv4.tcp_tw_reuse</code>和<code>net.ipv4.tcp_tw_recycle</code>参数，可以加快 TIME_WAIT 状态连接的回收。</p>
</li>
</ul>
<pre><code>sysctl -w net.ipv4.tcp_tw_reuse=1
sysctl -w net.ipv4.tcp_tw_recycle=1
</code></pre>
<p><strong>不过需要注意的是，tcp_tw_recycle参数在 NAT 网络环境下可能会导致丢包问题，在这种情况下应谨慎使用。</strong>
<strong>4.12版本之后的内核已经去掉了tcp_tw_recycle参数</strong></p>
<ul>
<li>
<p>1.8 优化nf_conntrack相关参数，支持高并发场景</p>
</li>
<li>
<ul>
<li>根据机器内存大小，合理设置nf_conntrack_max 和 hashsize</li>
</ul>
</li>
<li>
<ul>
<li>超大连接数场景,直接把一些特定端口的连接，直接不追踪.</li>
</ul>
</li>
<li>
<ul>
<li>参考第三章第五篇</li>
</ul>
</li>
<li>
<p>1.9 网卡层面开启GSO和GRO</p>
</li>
<li>
<ul>
<li>可以降低CPU消耗</li>
</ul>
</li>
<li>
<ul>
<li>参考第三章第六篇</li>
</ul>
</li>
<li>
<p>1.10 tcp_keepalive相关参数优化</p>
</li>
<li>
<ul>
<li>参考第三章第六篇</li>
</ul>
</li>
<li>
<p>1.11 优化 local_port_range 设置，支持主动大并发对外连接</p>
</li>
<li>
<ul>
<li>调整net.ipv4.ip_local_port_range参数，增加本地端口的使用范围，以满足大量并发连接的需求。</li>
</ul>
</li>
</ul>
<pre><code>sysctl -w net.ipv4.ip_local_port_range=&quot;1024 65535&quot;

</code></pre>
<p>上述命令将本地端口的使用范围设置为 1024 到 65535。</p>
<h3 id="2">2 内存</h3>
<ul>
<li>
<p>2.1 调整 swappiness 参数</p>
</li>
<li>
<ul>
<li><code>vm.swappiness</code>参数控制着系统将内存数据交换到磁盘交换分区（swap）的倾向程度，取值范围是 0 - 100。数值越高，表示系统越倾向于使用交换分区。对于内存资源较为充足的服务器，应尽量减少对交换分区的使用，以提高系统性能。</li>
</ul>
</li>
</ul>
<pre><code>sysctl -w vm.swappiness=10

</code></pre>
<ul>
<li>
<ul>
<li>将swappiness设置为 10，意味着系统在内存使用率较高时，才会相对较少地使用交换分区，更多地依赖物理内存。</li>
</ul>
</li>
<li>
<p>2.2 调整 dirty_ratio 和 dirty_background_ratio</p>
</li>
<li>
<p><code>vm.dirty_ratio</code>参数表示当系统内存中脏数据（已修改但尚未写入磁盘的数据）达到系统内存总量的一定百分比时，系统开始将脏数据同步到磁盘。<code>vm.dirty_background_ratio</code>则表示当系统内存中脏数据达到系统内存总量的一定百分比时，后台线程开始将脏数据同步到磁盘。</p>
</li>
</ul>
<pre><code>sysctl -w vm.dirty_ratio=15
sysctl -w vm.dirty_background_ratio=5
</code></pre>
<ul>
<li>
<ul>
<li>适当降低这两个参数的值，可以减少磁盘 I/O 压力，避免因大量脏数据同步而导致系统性能下降。</li>
</ul>
</li>
<li>
<p>2.3 启用透明大页</p>
</li>
<li>
<ul>
<li>减少页表数目，提升效率</li>
</ul>
</li>
</ul>
<pre><code>$ cat /sys/kernel/mm/transparent_hugepage/enabled
[always] madvise never


</code></pre>
<ul>
<li>
<ul>
<li>[always] 表示已经开启</li>
</ul>
</li>
<li>
<ul>
<li>[never] 表示透明大页禁用</li>
</ul>
</li>
<li>
<ul>
<li>[madvise] 表示只在MADV_HUGEPAGE标志的VMA中使用THP</li>
</ul>
</li>
<li>
<p>2.4 启用KSM</p>
</li>
<li>
<ul>
<li>开启ksmd内核线程，合并底层物理页，降低使用量</li>
</ul>
</li>
<li>
<p>2.5 调整 overcommit_memory 参数</p>
</li>
<li>
<ul>
<li><code>vm.overcommit_memory</code>参数控制着系统的内存分配策略，取值有 0、1、2。当取值为 0 时，系统会对内存分配进行保守估计，只有在确定有足够物理内存时才会分配内存；取值为 1 时，系统会允许超量分配内存，这在一些应用场景下可以提高内存的使用效率，但可能会导致系统在内存不足时出现 OOM（Out Of Memory）错误；取值为 2 时，系统会根据交换空间的大小来限制内存分配。</li>
</ul>
</li>
</ul>
<pre><code>
sysctl -w vm.overcommit_memory=1

</code></pre>
<ul>
<li>
<ul>
<li>对于一些内存使用需求波动较大，但对内存分配及时性要求较高的应用场景，可以将overcommit_memory设置为 1，但需要密切关注系统的内存使用情况，避免出现 OOM 错误导致系统不稳定。</li>
</ul>
</li>
<li>
<p>2.6 优化内存分配算法</p>
</li>
<li>
<ul>
<li>Linux 系统的内存分配算法主要有伙伴系统（Buddy System）和 slab 分配器。在一些特定的应用场景下，可以通过调整相关参数来优化内存分配算法的性能。例如，对于一些频繁分配和释放小块内存的应用，可以通过调整 slab 分配器的缓存大小来提高内存分配效率。</li>
</ul>
</li>
</ul>
<pre><code># 调整slab分配器的缓存大小
echo &quot;1024&quot; &gt; /sys/kernel/mm/slab/ kmem_cache_name/slab_size

</code></pre>
<ul>
<li>
<ul>
<li>其中kmem_cache_name是具体的缓存名称，不同的缓存名称对应不同类型的内存对象分配。具体的调整值需要根据应用的内存使用模式和性能测试结果来确定。</li>
</ul>
</li>
</ul>
<h3 id="3">3 文件系统</h3>
<ul>
<li>
<p>3.1 进程打开的文件数上限</p>
</li>
<li>
<ul>
<li>内核参数: <code>fs.file-max</code>,<code>fs.nr_open</code> ; 系统配置文件: <code>/etc/security/limits.conf</code></li>
</ul>
</li>
<li>
<p>3.2 为不同应用场景选择不同文件系统</p>
</li>
<li>
<ul>
<li><a href="https://mp.weixin.qq.com/s/iQ869MImH6GDTfyqFoqECw">EXT4和XFS区别</a></li>
</ul>
</li>
<li>
<ul>
<li>XFS适用于大文件场景、并且不适合作为/目录、支持不停服扩容. EXT4适合小文件场景, 需要停服扩容.</li>
</ul>
</li>
<li>
<p>3.3 具体到某个文件系统优化挂载参数</p>
</li>
<li>
<ul>
<li>除了noatime选项外，还可以根据实际需求调整其他挂载参数。例如，对于一些对数据一致性要求较高的应用场景，可以使用data=journal选项来确保文件系统在写入数据时先将数据写入日志，然后再写入数据块，从而提高数据的安全性，但这可能会稍微降低一些性能。</li>
</ul>
</li>
</ul>
<pre><code>
/dev/sda1 / ext4 defaults,noatime,data=journal 0 0

</code></pre>
<p>对于一些对性能要求极高且对数据一致性风险有一定承受能力的场景，可以考虑使用data=writeback选项，它可以提高写入性能，但可能会在系统崩溃等极端情况下存在一定的数据丢失风险。</p>
<pre><code>/dev/sda1 / ext4 defaults,noatime,data=writeback 0 0

</code></pre>
<h3 id="4-io">4 硬盘IO</h3>
<ul>
<li>4.1 零拷贝</li>
<li>
<ul>
<li>根据业务场景，灵活运用<strong>sendfile</strong>、<strong>mmap</strong>、<strong>Direct IO</strong> 三种零拷贝技术. 参考第五章第三篇</li>
</ul>
</li>
<li>
<p>4.2 块IO层优化</p>
</li>
<li>
<ul>
<li>Generic Block Device Layer: 在CFQ前提下，为不同优先级进程选择不同IO classes, 常用的 IO classess 包括: Idle、Best-effort、Realtime.</li>
</ul>
</li>
<li>
<ul>
<li>电梯层： 选择合适的调度算法： <strong>Deadline</strong>，<strong>CFQ</strong>，<strong>NOOP</strong></li>
</ul>
</li>
<li>
<ul>
<li>适当加大 request queue 的长度</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>/sys/block/sda/queue/nr_requests (块层最大可以申请的 request 数量)</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>/sys/block/sda/queue/read_ahead_kb (预读最大的数据量)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>4.3 物理设备</p>
</li>
<li>
<ul>
<li>开启Raid卡缓存</li>
</ul>
</li>
</ul>
<h3 id="5">5 网卡数据链路层</h3>
<ul>
<li>5.1  启用巨帧（Jumbo Frames）</li>
<li>
<ul>
<li>巨帧是指超过标准以太网帧大小（1500 字节）的网络帧。在一些局域网环境中，启用巨帧可以减少网络传输中的帧头开销，提高网络传输效率。首先需要确保网络设备（如网卡、交换机）都支持巨帧功能。然后，在 Linux 系统中，可以通过以下命令启用巨帧：</li>
</ul>
</li>
</ul>
<pre><code>ifconfig eth0 mtu 9000

</code></pre>
<p>上述命令将eth0网络接口的最大传输单元（MTU）设置为 9000 字节。需要注意的是，MTU 值的设置需要根据网络环境中的最小 MTU 值来确定，以避免出现网络分片问题。</p>
<ul>
<li>5.2 调整网络接口速率和双工模式
使用ethtool工具可以查看和调整网络接口的速率、双工模式等参数。确保网络接口工作在最佳的速率和双工模式下，可以避免因网络接口参数不匹配而导致的性能下降。</li>
</ul>
<pre><code># 查看网络接口当前的速率和双工模式
sudo ethtool eth0
# 设置网络接口的速率为1000Mbps，双工模式为全双工
sudo ethtool -s eth0 speed 1000 duplex full
</code></pre>
<h3 id="6">6  网络服务优化</h3>
<p>6.1 优化 DNS 解析
DNS 解析的速度会影响网络应用的访问速度。可以通过安装并启用nscd服务来缓存 DNS 查询结果，加快 DNS 解析速度。</p>
<pre><code># 安装nscd服务
sudo apt-get install nscd
# 启动nscd服务
sudo systemctl start nscd
# 设置nscd服务开机自启
sudo systemctl enable nscd

</code></pre>
<p>此外，还可以通过修改/etc/resolv.conf文件，选择更可靠、速度更快的 DNS 服务器。例如，可以使用公共 DNS 服务器，如 Google 的 DNS 服务器（8.8.8.8 和 8.8.4.4）或 Cloudflare 的 DNS 服务器（1.1.1.1 和 1.0.0.1）。</p>
<pre><code>nameserver 8.8.8.8
nameserver 8.8.4.4

</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../13_classic_thinkings/" class="btn btn-neutral float-left" title="第十三篇 经典思维"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../15_secure_sre/" class="btn btn-neutral float-right" title="第十五篇 安全运维">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../13_classic_thinkings/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../15_secure_sre/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
