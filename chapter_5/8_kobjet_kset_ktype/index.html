<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>第八篇 Linux设备模型的基石:kset/kobject/ktype - Lott's Blog</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u7b2c\u516b\u7bc7 Linux\u8bbe\u5907\u6a21\u578b\u7684\u57fa\u77f3:kset/kobject/ktype";
        var mkdocs_page_input_path = "chapter_5/8_kobjet_kset_ktype.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Lott's Blog
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">第一章 各种杂项基础</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/1_make_blog/">第一篇 利用Github Pages和mkdocs搭建个人博客</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/2_nginx_loadbalancing_strategy/">第二篇 Nginx的均衡策略</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/3_linux_kernel_basic/">第三篇 Linux内核基础</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/4_linux_kernel_mm_basic/">第四篇 Linux内核空间内存概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/5_how_kernel_call_bios/">第五篇 Linux内核调用BIOS案例</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/9_linux_arch_overall_introduction/">第九篇 Linux架构整体介绍</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/10_virtual_machine_on_mac_m1_chip/">第十篇 Mac M1芯片电脑利用Qemu安装Debian虚拟机</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/11_nftables/">第十一篇 Debian 11以及往后版本nftables防火墙配置</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/12_ansible_basic_use/">第十二篇 Ansible简单使用笔记</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/13_tty_terminal_console/">第十三篇 终端(Terminal)、TTY、PTY和控制台(Console)区别</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/14_qemu_use/">第十四篇 QEMU模拟各类开发板</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/15_bosun/">第十五篇 Bosun使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/16_assembler/">第十六篇 汇编语言使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/17_makefile/">第十七篇 Makefile使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/19_network_ratelimit/">第十九篇 Linux网络限速</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/20_mac_os_skills/">第二十篇 MacOS使用技巧</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_1/21_debian_skills/">第二十一篇 Debian使用技巧</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第二章 运维工作总结</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/yunweijiazhi/">第一篇 运维的价值和目标</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/yunweizhiyeguifan/">第二篇 业务SRE的职业规范</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/yunweipingtailinian/">第三篇 运维平台建设的理念</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/guzhangguanli/">第四篇 故障管理概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/biangengguanli/">第五篇 变更管理概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/rongliangguanli/">第六篇 容量管理概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/jiagoushisiweihetezhi/">第七篇 架构师思维和特质以及中间件技术梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/cicd/">第八篇 CICD流程概述</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/9_changkanchangxin/">第九篇 常看常新</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/12_monitor_and_alert/">第十二篇 监控报警最佳实践</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/13_classic_thinkings/">第十三篇 经典思维</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/14_performance_optimization_topic/">第十四篇 性能调优</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/15_secure_sre/">第十五篇 安全运维</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/16_yunweijiazhi/">第十六篇 公司视角下运维的价值</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_2/17_cdn_sre/">第十七篇 CDN运维</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第三章 Linux Net子系统</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/1_linux_kernel_net/">第一篇 Linux数据包接收路径梳理和常用调优技能</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/2_estab_queue_monitoring/">第二篇 Linux下如何观察完整连接队列的情况</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/3_net_ipv4_tcp_syn_retries/">第三篇 理解net.ipv4.tcp_syn_retries设置</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/4_linux_kernel_net_v2/">第四篇 Linux网络数据包的揭秘以及常见的调优方式总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/5_conntrack/">第五篇 conntrack的常见应用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/6_tcp/">第六篇 TCP协议总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/7_udp/">第七篇 UDP协议总结以及TCP和UDP的区别</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/8_io_multiplexing/">第八篇 IO多路复用总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/10_linux_net/">第十篇 Linux Net子系统总结、收发包流程再次梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/11_igb/">第十一篇 igb网卡驱动梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/12_rss_rps_rfs_xps/">第十二篇 Linux网卡rss和rps和rfs和xps</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_3/13_linghunkaowen/">第十三篇 Linux网络子系统灵魂拷问</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第四章 Linux CPU子系统</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/1_process_ulimit/">第一篇 进程Max open files的设置</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/2_pid_max/">第二篇 kernel源码中pid的最大值</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/3_interrupt_one/">第三篇 硬中断</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/5_soft_irq/">第四篇 软中断</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/4_process_thread_coroutine/">第五篇 进程、线程、协程</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/6_cpu_famous_register/">第六篇 CPU中的著名寄存器梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/7_linux_signal/">第七篇 Linux信号机制</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/8_linux_scheduler/">第八篇 Linux进程调度</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/10_linux_context_switch/">第十篇 低视角看context switch</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/11_linux_cpu_usage/">第十一篇 CPU利用率统计</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/12_linux_preemption/">第十二篇 内核抢占基础篇</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/13_interrupt_handler_examples/">第十三篇 中断处理程序的例子</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/14_linux_kernel_tracing/">第十四篇 理解内核追踪机制</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/15_task_struct/">第十五篇 task_struct结构体总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/16_init_call/">第十六篇 Linux各类initcall总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/17_coredump/">第十七篇 Linux coredump总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_4/18_cpu_CacheLine/">第十八篇 CPU CacheLine总结</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第五章 Linux IO子系统</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../1_four_object_of_VFS/">第一篇 VFS四大对象inode、dentry、super_block、file数据结构总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2_io_stack/">第二篇 Linux IO栈总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../3_zero_copy/">第三篇 Linux 零拷贝技术总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../4_io_scheduler_layer/">第四篇 Block IO Layer(块IO层)总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../6_fss/">第六篇 各类文件系统梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../7_three_object_of_block_device/">第七篇 块设备三大对象block_device、gendisk、hd_struct数据结构总结</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">第八篇 Linux设备模型的基石:kset/kobject/ktype</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_2">一 架构图和一些总体规则</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_3">二 数据结构详解和数据结构之间的关系</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#21-kobject">2.1 kobject</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#22-kset">2.2 kset</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#22-sysbus">2.2 扩展(/sys/bus)源码</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#23-kobj_type">2.3 kobj_type</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#24-kobject-sys_ops">2.4 kobject 操作函数集, sys_ops</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#25-kobject-struct-attribute">2.5 kobject 的属性 struct attribute</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#26">2.6 更详细的架构图</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#27">2.7 结构关系</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_4">三 流程分析</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#kobjectksetktype-linux">四 一个使用 kobject/kset/ktype 的例子（Linux 驱动的常用手法)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#41">4.1 代码</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#42-makefile">4.2 Makefile</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#43">4.3 测试结果</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#44">4.4 更多例子</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_5">五 参考文档</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../9_io_uring/">第九篇 io_uring研究和总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../10_device_database/">第十篇 设备数据库</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第六章 Linux Mem子系统</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/1_linux_buddy/">第一篇 伙伴系统介绍</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/2_slab/">第二篇 Slab层介绍</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/3_virtual_memory/">第三篇 进程虚拟地址空间介绍</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/4_linux_mem_theory/">第四篇 Linux内存管理基础篇</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/6_alloc_mem_apis/">第六篇 Linux内核内存分配API函数分类</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/7_physical_memory/">第七篇 关于物理内存管理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/8_linux_mm_update/">第八篇 Linux内存管理升级篇</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_6/9_page_cache_and_buffer_cache/">第九篇 PageCache和BufferCache演进过程</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第七章 运维小技巧和工具汇总和积累</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/1_sync_file/">第一篇 不同主机之间的文件传输</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/2_sre_tools_python/">第二篇 运维生产力工具(python篇)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/3_sre_tools_website/">第三篇 运维生产力工具(网站工具)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/4_sre_tools_shell/">第四篇 运维生产力工具(shell篇)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/5_server_side_evolution/">第五篇 服务端进化过程梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/7_charset/">第七篇 字符集和编码</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/8_locale/">第八篇 locale设置</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/9_http_protocol/">第九篇 http协议</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_7/10_http_cookie_session_token/">第十篇 cookie和session和token总结</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第八章 职场通用经验</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/1_xuexixinde/">第一篇 学习心得和工作箴言</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/2_bangzhuqitatongxue/">第二篇 工作能力评价体系</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/3_yewuliuchengshuyu/">第三篇 项目管理总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/4_jishunenglimoxing/">第四篇 技术能力模型总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/5_chanpingsiwei_1/">第五篇 产品思维总结和梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/6_jixiaobaogao/">第六篇 如何写绩效报告</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/7_xiangshangguanli/">第七篇 如何向上管理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/9_speaking_skills/">第九篇 沟通能力和演讲技巧</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/10_jixiaofangtan/">第十篇 绩效访谈总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_8/11_classic_technical_thinking/">第十一篇 经典技术思维汇总</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第九章 编程经验和各类开源软件</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/1_suanfa/">第一篇 算法总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/2_data_structure/">第二篇 数据结构总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/3_c_lang/">第三篇 c语言总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/4_symbol_table/">第四篇 符号表总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/5_golang/">第五篇 go语言总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/6_linux_kernel_patch/">第六篇 手把手教你向Linux Kernel提交Patch</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/7_python/">第七篇 python语言总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/8_rsyslog/">第八篇 rsyslog</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/9_falcon/">第九篇 falcon和夜莺</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/10_json_schema/">第十篇 JSON-Schema使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/11_prometheus/">第十一篇 Prometheus使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/12_grafana/">第十二篇 Grafana使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/13_mysql/">第十三篇 MySQL使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/14_mongodb/">第十四篇 MongoDB使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/15_supervisor/">第十五篇 Supervisor使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/16_redis/">第十六篇 Redis使用</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/17_mongodb_2/">第十七篇 MongoDB基础</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/18_elk_2/">第十八篇 ELK基础</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/19_gitlab_ce/">第十九篇 Gitlab-CE维护</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/20_minio/">第二十篇 MinIO维护</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/21_elk_1/">第二十一篇 ELK维护</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/22_httpdns/">第二十二篇 HTTPDNS梳理</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/23_ssl_certs/">第二十三篇 SSL证书总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_9/24_p4/">第二十四篇 P4服务器梳理</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十章 容器化和Kubernetes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/1_dockerfile_best_practice/">第一篇 dockerfile最佳实践</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/2_benefits_of_containerization/">第二篇 容器化好处</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/3_docker_basic_concepts/">第三篇 容器化基础概念</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/4_kubernetes_basic_concepts/">第四篇 Kubernetes基础概念</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/6_production_kubernetes_best_practice/">第六篇 生产环境Kubernetes部署最佳实践</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/7_production_kerbernetes_yaml/">第七篇 生产环境Kubernetes YAML模版</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/8_Calico/">第八篇 Kubernetes网络插件之Calico</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/9_cloudnative_monitor/">第九篇 云原生监控</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/10_event/">第十篇 彻底搞懂Kubernetes Event</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/11_best_practices/">第十一篇 Kubernetes最佳实践</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/12_cloud_network/">第十二篇 云网络</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/13_containerd/">第十三篇 Containerd</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/14_k8s_and_gpu/">第十四篇 基于K8S管理GPU集群</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_10/15_public_cloud_use/">第十五篇 公有云最佳实践总结</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十一章 SRE稳定性建设从理论到实践</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_11/1_theory/">第一篇 稳定性概论</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_11/10_high_avaliable/">第二篇 高可用原则总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_11/2_slo_process/">第三篇 SLO实施流程</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_11/3_stress/">第四篇 压测经验总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_11/11_stability/">第五篇 稳定性理论总结</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十二章 商业化知识总结</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_12/1_shifouzhide/">第一篇 如何判断一件事情值不值得做</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十三章 芯片知识总结</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_13/1_about_riscv/">第一篇 RISC-V 简介</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_13/2_danpianji/">第二篇 单片机简介</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十四章 Linux驱动方向总结</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/1_demo_of_led_driver/">第一篇 驱动程序的Hello World</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/2_qianrushidev/">第二篇 嵌入式开发基础</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/3_linux_kernel_api_list/">第三篇 Linux内核API汇总和各类风格总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/4_zifushebeiqudongyuanli/">第四篇 字符设备驱动实现原理和物理内存地址空间和IO端口空间</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/5_device_tree/">第五篇 platform总线模型和设备树</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/6_device_driver_sop/">第六篇 从阅读硬件手册开始设备驱动程序编写</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/7_linux_kernel_clipping/">第七篇 Linux移植</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/8_linux_driver_framework/">第八篇 Linux驱动框架和SoC驱动框架</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/9_linux_device_class/">第九篇 Linux设备分类</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/10_u_boot/">第十篇 u-boot梳理和总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/11_linux_reset_subsystem_and_framework/">第十一篇 Linux Reset子系统及其框架</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/12_pinctl_and_gpio/">第十二篇 Linux pinctl和gpio子系统及其框架</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/13_embedded_development_direction/">第十三篇 嵌入式开发方向和分类</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/14_linux_kernel_trimming/">第十四篇 Linux内核裁剪总结</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_14/15_imx6ull/">第十五篇 IMX6UL实验记录</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十五章 AI+嵌入式结合方向汇总</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_15/1_basic_of_ai/">第一篇 AI入门</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_15/2_nvidia_gpu/">第二篇 英伟达GPU产品分类</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">第十六章 网络安全方向</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../chapter_16/1_network_attack/">第一篇 认识各种网络攻击</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Lott's Blog</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">第五章 Linux IO子系统</li>
      <li class="breadcrumb-item active">第八篇 Linux设备模型的基石:kset/kobject/ktype</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">概述</h1>
<ul>
<li>
<p>接触<code>kobject/kset/ktype</code>和<code>sys文件系统</code>有一段时间了, 本文进行一个梳理和总结</p>
</li>
<li>
<p>Linux 设备模型的基石是<code>kset/kobject/kobj_type</code></p>
</li>
<li>辅助对象包含<code>struct sys_ops</code>及其包含的<code>show</code>和<code>shtore</code>函数, <code>struct attribute</code>、</li>
<li>通讯机制 <code>struct kset_uevent_ops</code></li>
</ul>
<h2 id="_2">一 架构图和一些总体规则</h2>
<ul>
<li><strong>sys 文件系统</strong>的架构图</li>
</ul>
<p><img alt="png" src="../../img/3959F415-D00E-4C85-B927-AD1C7890E6DD.jpg" /></p>
<ul>
<li><code>sysfs 文件系统</code>提供了一种用户与内核数据结构进行交互的方式，可以通过 <code>mount -t sysfs sysfs /sys</code> 来进行挂载；</li>
<li>
<ul>
<li>Linux 设备模型中，<strong>设备、驱动、总线</strong>组织成拓扑结构，通过 <code>sysfs 文件系统</code>以目录结构进行展示与管理；</li>
</ul>
</li>
<li>
<p>Linux 设备模型中，<strong>总线</strong>负责<strong>设备</strong>和<strong>驱动</strong>的匹配，<strong>设备</strong>与<strong>驱动</strong>都挂在某一个<strong>总线</strong>上，当它们进行注册时由<strong>总线</strong>负责去完成匹配，进而回调<strong>驱动</strong>的 <code>probe 函数</code>；</p>
</li>
<li>
<ul>
<li>这里的设备和驱动具体实现都是<strong>内核模块</strong>,<code>XXXX_device.ko</code> 和 <code>XXXX_driver.ko</code>.</li>
</ul>
</li>
<li>
<p>SoC 系统中有 spi, i2c, pci 等实体总线用于外设的连接，而针对集成在 SoC 内部的外设控制器，Linux 内核提供一种虚拟总线 platform 用于这些外设控制器的连接，此外 platform 总线也可用于没有实体总线的外设；</p>
</li>
<li>
<p>在/sys 目录下，bus 用于存放各类总线，其中总线中会存放挂载在该总线上的驱动和设备，比如 serial8250，devices 存放了系统中的设备信息，class 是针对不同的设备进行分类；</p>
</li>
</ul>
<p>上边这些功能的实现，离不开 kobject/kset/ktype 机制的支撑，开始旅程吧。</p>
<h2 id="_3">二 数据结构详解和数据结构之间的关系</h2>
<p><img alt="png" src="../../img/WechatIMG336.jpg" /></p>
<h3 id="21-kobject">2.1 kobject</h3>
<ul>
<li><code>kobject</code>代表内核对象，结构体本身不单独使用，而是嵌套在其他高层结构中，用于组织成拓扑关系；</li>
<li><code>sysfs文件系统</code>中一个<code>目录</code>对应一个<code>kobject</code>；</li>
<li><code>目录</code>下的一个文件对应一个<code>attribute</code></li>
</ul>
<p>看看结构体吧：</p>
<pre><code>struct kobject {
    const char      *name;                  /* 名字，对应sysfs下的一个目录 */
    struct list_head    entry;               /* kobject中插入的 list_head结构，用于构造双向链表 */
    struct kobject      *parent;            /* 指向当前kobject父对象的指针，体现在sys中就是包含当前kobject对象的目录对象 */
    struct kset     *kset;                    /* 当前kobject对象所属的集合 */
    struct kobj_type    *ktype;            /* 当前kobject对象的类型 */
    struct kernfs_node  *sd;              /* VFS文件系统的目录项，是设备和文件之间的桥梁，sysfs中的符号链接是通过kernfs_node内的联合体实现的 */
    struct kref     kref;                     /* kobject的引用计数，当计数为0时，回调之前注册的release方法释放该对象 */
#ifdef CONFIG_DEBUG_KOBJECT_RELEASE
    struct delayed_work release;
#endif
    unsigned int state_initialized:1;                /* 初始化标志位，初始化时被置位 */
    unsigned int state_in_sysfs:1;                  /* kobject在sysfs中的状态，在目录中创建则为1，否则为0 */
    unsigned int state_add_uevent_sent:1;      /* 添加设备的uevent事件是否发送标志，添加设备时向用户空间发送uevent事件，请求新增设备 */
    unsigned int state_remove_uevent_sent:1;  /* 删除设备的uevent事件是否发送标志，删除设备时向用户空间发送uevent事件，请求卸载设备 */
    unsigned int uevent_suppress:1;              /* 是否忽略上报（不上报uevent） */
};

</code></pre>
<h3 id="22-kset">2.2 kset</h3>
<ul>
<li>
<p><code>kset</code> 是包含多个 <code>kobject</code> 的集合；</p>
</li>
<li>
<p>如果需要在 <code>sysfs</code> 的目录中包含多个子目录，那需要将它定义成一个 <code>kset</code>；</p>
</li>
<li>
<p><code>kset</code> 结构体中包含 <code>struct kobject</code> 字段，可以使用该字段链接到更上一层的结构，用于构建更复杂的拓扑结构；</p>
</li>
<li>
<p><code>sysfs</code> 中的设备组织结构很大程度上根据 <code>kset</code> 组织的，<code>/sys/bus</code> 目录就是一个 <code>kset</code> 对象，在 Linux 设备模型中，<strong>注册设备或驱动时</strong>就将 <code>kobject</code> 添加到对应的 <code>kset</code> 中；</p>
</li>
</ul>
<pre><code>
struct kset {
    struct list_head list;        /* 包含在kset内的所有kobject构成一个双向链表 */
    spinlock_t list_lock;
    struct kobject kobj;       /* 归属于该kset的所有的kobject的共有parent */
    const struct kset_uevent_ops *uevent_ops;    /* kset的uevent操作函数集，当kset中的kobject有状态变化时，会回调这个函数集，以便kset添加新的环境变量或过滤某些uevent，如果一个kobject不属于任何kset时，是不允许发送uevent的 */
} __randomize_layout;

</code></pre>
<h3 id="22-sysbus">2.2 扩展(/sys/bus)源码</h3>
<ul>
<li>向系统添加一条 bus_type 总线时，改总线会自动添加到<strong>/sys/bus 目录</strong>下，<strong>bus 目录</strong>是系统自动创建的，这个 bus 目录为<code>static struct kset *bus_kset</code>，定义在<code>drivers/base/bus.c</code>中。创建过程如下所示：</li>
</ul>
<pre><code>static struct kset *bus_kset;
</code></pre>
<ul>
<li>
<p>/sys/bus 目录的建立过程：drivers/base/bus.c</p>
</li>
<li>
<ul>
<li>--&gt;buses_init</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>--&gt;kset_create_and_add 　　//这行代码建立/sys 下面的 bus 目录，其中 bus_kset 就代表 bus 目录</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>int __init buses_init(void)
{
    bus_kset = kset_create_and_add(&quot;bus&quot;, &amp;bus_uevent_ops, NULL); // 第一个参数是bus目录，第二个参数是对应kset_uevent_ops结构, 第三个参数是父kobject
    if (!bus_kset)
        return -ENOMEM;

    system_kset = kset_create_and_add(&quot;system&quot;, NULL, &amp;devices_kset-&gt;kobj);
    if (!system_kset)
        return -ENOMEM;

    return 0;
}

/**
 * kset_create_and_add - 创建一个动态的kset 结构并添加到sysfs中

 *
 * @name:  kset名称
 * @uevent_ops: kset的kset_uevent_ops 结构
 * @parent_kobj: kset的付kobject，如果有的话
 *
 * 该方法创建一个动态的kset结构，并注册到sysfs上。用完该结构之后

 * 调用kset_unregister() ，该结构将会被动态的释放，之后该结构将不再

 * 被使用。

 *
 * 当无法创建kset，将返回NULL
 */

</code></pre>
<h3 id="23-kobj_type">2.3 kobj_type</h3>
<ul>
<li>
<p><code>kobj_type</code>用于表征<code>kobject</code>的类型，指定了删除<code>kobject</code>时要调用的函数，<code>kobject</code>结构体中有<code>struct kref</code>字段用于对<code>kobject</code>进行引用计数，当计数值为 0 时，就会调用<code>kobj_type</code>中的<code>release</code>函数对<code>kobject</code>进行释放，这个就有点类似于<code>C++</code>中的智能指针了；</p>
</li>
<li>
<p><code>kobj_type</code>指定了通过<code>sysfs</code>显示或修改有关<code>kobject</code>的信息时要处理的操作，实际是调用<code>show/store</code>函数；</p>
</li>
<li>
<p><code>kobject</code>和<code>kobj_type</code>是 1 对 1 关系</p>
</li>
</ul>
<pre><code>
struct kobj_type {
    void (*release)(struct kobject *kobj);     /* 释放kobject对象的接口，有点类似面向对象中的析构 */
    const struct sysfs_ops *sysfs_ops;        /* 操作kobject的方法集 */
    struct attribute **default_attrs;
    const struct kobj_ns_type_operations *(*child_ns_type)(struct kobject *kobj);
    const void *(*namespace)(struct kobject *kobj);
};

</code></pre>
<h3 id="24-kobject-sys_ops">2.4 kobject 操作函数集, sys_ops</h3>
<pre><code>
struct sysfs_ops {      /* kobject操作函数集 */
    ssize_t (*show)(struct kobject *, struct attribute *, char *);
    ssize_t (*store)(struct kobject *, struct attribute *, const char *, size_t);
};
</code></pre>
<h3 id="25-kobject-struct-attribute">2.5 kobject 的属性 struct attribute</h3>
<pre><code>/* 所谓的attribute就是内核空间和用户空间进行信息交互的一种方法，例如某个driver定义了一个变量，却希望用户空间程序可以修改该变量，以控制driver的行为，那么可以将该变量以sysfs attribute的形式开放出来 */
struct attribute {
    const char      *name;
    umode_t         mode;
#ifdef CONFIG_DEBUG_LOCK_ALLOC
    bool            ignore_lockdep:1;
    struct lock_class_key   *key;
    struct lock_class_key   skey;
#endif
};
</code></pre>
<ul>
<li><code>kobject</code>对应<code>sys文件系统</code>下的一个目录, 而<code>attribute</code>就对应目录下的一个文件, 方便用户空间对属性进行修改</li>
</ul>
<h3 id="26">2.6 更详细的架构图</h3>
<ul>
<li>可以看一下<code>kobject</code>创建的时候，与<code>ktype</code>的关系，这样理解起来更顺：</li>
</ul>
<p><img alt="png" src="../../img/WechatIMG337.jpg" /></p>
<ul>
<li>
<p><code>kobject</code>在创建的时候，默认设置<code>kobj_type</code>的值为<code>dynamic_kobj_ktype</code>，通常<code>kobject</code>会嵌入在其他结构中来使用，因此它的初始化跟特定的结构相关，典型的比如<code>struct device</code>和<code>struct device_driver</code>；</p>
</li>
<li>
<p>在<code>/sys文件系统</code>中，通过<code>echo/cat</code>的操作，最终会调用到<code>show/store</code>函数，而这两个函数的具体实现可以放置到驱动程序中；</p>
</li>
</ul>
<h3 id="27">2.7 结构关系</h3>
<p>为了更形象的说明这几个结构体的关系，再来一张图：</p>
<p><img alt="png" src="../../img/WechatIMG338.jpg" /></p>
<ul>
<li>
<ul>
<li><code>kset</code>既是<code>kobject</code>的集合，本身又是一个<code>kobject</code>，进而可以添加到其他的集合中，从而就可以构建成复杂的拓扑结构，满足<code>/sys文件夹</code>下的文件组织需求；</li>
</ul>
</li>
<li>
<p>如果只看<code>kset/kobject</code>的数据结构组织，可能还是会迷惑，它怎么跟 Linux 的设备模型相关？这时就不得不提到 Linux 内核中一个很精妙的存在<code>container_of</code>，它可以通过成员变量的地址来获取所在结构的地址信息。前文提到过<code>kobject/kset</code>结构本身不会单独使用，<strong>通常都是会嵌套在其他结构中</strong>，既然<code>kobjcet/kset</code>能组织成拓扑结构，那么包含它们的结构同样可以构建这个关系，因为可以通过<code>container_of</code>就可以找到结构体的首地址。</p>
</li>
</ul>
<p><img alt="png" src="../../img/WechatIMG339.jpg" /></p>
<ul>
<li>
<p>结构体 A、B、C、D、E 同样可以构建拓扑结构关系；</p>
</li>
<li>
<p><code>struct device</code>和<code>struct device_driver</code>结构体中都包含了<code>struct kobject</code>，而<code>struct bus_type</code>结构体中包含了<code>struct kset</code>结构，这个也就<strong>对应到前文提到的设备和驱动都添加到总线上，由总线来负责匹配</strong>；</p>
</li>
</ul>
<h2 id="_4">三 流程分析</h2>
<ul>
<li><code>kobject/kset</code>的相关代码比较简单，毕竟它只是作为一个结构体嵌入其他 high-level 的结构中，充当纽带的作用。不过，我还是简单的上一张图吧：</li>
</ul>
<p><img alt="png" src="../../img/WechatIMG342.jpg" /></p>
<ul>
<li>完成的工作基本就是分配结构体，初始化各个结构体字段，构建拓扑关系（主要是添加到<code>kset</code>的<code>list</code>中，<code>parent</code>的指向等）等，看懂了结构体的组织，这部分的代码理解起来就很轻松了；</li>
</ul>
<h2 id="kobjectksetktype-linux">四 一个使用 kobject/kset/ktype 的例子（Linux 驱动的常用手法)</h2>
<p><img alt="png" src="../../img/WechatIMG340.jpg" /></p>
<h3 id="41">4.1 代码</h3>
<pre><code>#include &lt;linux/kernel.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/slab.h&gt;
#include &lt;linux/kobject.h&gt;

//自定义一个结构，包含了struct kobject子结构
struct test_kobj {
    int value;
    struct kobject kobj;
};

//自定义个属性结构体，包含了struct attribute结构
struct test_kobj_attribute {
    struct attribute attr;
    ssize_t (*show)(struct test_kobj *obj, struct test_kobj_attribute *attr, char *buf);
    ssize_t (*store)(struct test_kobj *obj, struct test_kobj_attribute *attr, const char *buf, size_t count);
};

//声明一个全局结构用于测试
struct test_kobj *obj;

//用于初始化sysfs_ops中的函数指针
static ssize_t test_kobj_attr_show(struct kobject *kobj, struct attribute *attr, char *buf)
{
    struct test_kobj_attribute *test_kobj_attr;
    ssize_t ret = -EIO;

    test_kobj_attr = container_of(attr, struct test_kobj_attribute, attr);

    //回调到具体的实现函数
    if (test_kobj_attr-&gt;show)
        ret = test_kobj_attr-&gt;show(container_of(kobj, struct test_kobj, kobj), test_kobj_attr, buf);

    return ret;
}

//用于初始化sysfs_ops中的函数指针
static ssize_t test_kobj_attr_store(struct kobject *kobj, struct attribute *attr, const char *buf, size_t count)
{
    struct test_kobj_attribute *test_kobj_attr;
    ssize_t ret = -EIO;

    test_kobj_attr = container_of(attr, struct test_kobj_attribute, attr);

    //回调到具体的实现函数
    if (test_kobj_attr-&gt;store)
        ret = test_kobj_attr-&gt;store(container_of(kobj, struct test_kobj, kobj), test_kobj_attr, buf, count);

    return ret;
}

//用于初始化kobj_ktype
const struct sysfs_ops test_kobj_sysfs_ops = {
    .show = test_kobj_attr_show,
    .store = test_kobj_attr_store,
};

//用于初始化kobj_ktype，最终用于释放kobject
void obj_release(struct kobject *kobj)
{
    struct test_kobj *obj = container_of(kobj, struct test_kobj, kobj);

    printk(KERN_INFO &quot;test kobject release %s\n&quot;, kobject_name(&amp;obj-&gt;kobj));

    kfree(obj);
}

//定义kobj_ktype，用于指定kobject的类型，初始化的时候使用
static struct kobj_type test_kobj_ktype = {
    .release = obj_release,
    .sysfs_ops = &amp;test_kobj_sysfs_ops,
};

//show函数的具体实现
ssize_t name_show(struct test_kobj *obj, struct test_kobj_attribute *attr, char *buffer)
{
    return sprintf(buffer, &quot;%s\n&quot;, kobject_name(&amp;obj-&gt;kobj));
}

//show函数的具体实现
ssize_t value_show(struct test_kobj *obj, struct test_kobj_attribute *attr, char *buffer)
{
    return sprintf(buffer, &quot;%d\n&quot;, obj-&gt;value);
}

//store函数的具体实现
ssize_t value_store(struct test_kobj *obj, struct test_kobj_attribute *attr, const char *buffer, size_t size)
{
    sscanf(buffer, &quot;%d&quot;, &amp;obj-&gt;value);

    return size;
}

//定义属性，最终注册进sysfs系统
struct test_kobj_attribute name_attribute = __ATTR(name, 0664, name_show, NULL);
struct test_kobj_attribute value_attribute = __ATTR(value, 0664, value_show, value_store); //使用__ATTR宏,定义一个属性(对应sysfs下的一个文件)、权限、读函数、写函数
struct attribute *test_kobj_attrs[] = {
    &amp;name_attribute.attr,
    &amp;value_attribute.attr,
    NULL,
};

//定义组. 我们知道每个kobject对应/sys目录下的一个子目录, 该子目录下的目录可以继续是kobject(如果是kobject那必然是一个子目录), 也可以是单纯的子目录(没有kobject与之对应), 那么就可以采用attribute_group来实现
struct attribute_group test_kobj_group = {
    .name = &quot;test_kobj_group&quot;,
    .attrs = test_kobj_attrs,
};

//模块初始化函数
static int __init test_kobj_init(void)
{
    int retval;
    printk(KERN_INFO &quot;test_kobj_init\n&quot;);
    printk(&quot;%s %s line %d test_kobj_init\n&quot;, __FILE__, __FUNCTION__, __LINE__);
    obj = kmalloc(sizeof(struct test_kobj), GFP_KERNEL);
    if (!obj) {
        return -ENOMEM;
    }

    obj-&gt;value = 1;
    memset(&amp;obj-&gt;kobj, 0, sizeof(struct kobject));
    //添加进sysfs系统
    kobject_init_and_add(&amp;obj-&gt;kobj, &amp;test_kobj_ktype, NULL, &quot;test_kobj&quot;);

    //在sys文件夹下创建文件
    retval = sysfs_create_files(&amp;obj-&gt;kobj, (const struct attribute **)test_kobj_attrs);
    if (retval) {
        kobject_put(&amp;obj-&gt;kobj);
        return retval;
    }

    //在sys文件夹下创建group
    retval = sysfs_create_group(&amp;obj-&gt;kobj, &amp;test_kobj_group);
    if (retval) {
        kobject_put(&amp;obj-&gt;kobj);
        return retval;
    }

    return 0;
}

//模块清理函数
static void __exit test_kobj_exit(void)
{
    printk(KERN_INFO &quot;test_kobj_exit\n&quot;);
    printk(&quot;%s %s line %d test_kobj_exit\n&quot;, __FILE__, __FUNCTION__, __LINE__);

    kobject_del(&amp;obj-&gt;kobj);
    kobject_put(&amp;obj-&gt;kobj);

    return;
}

module_init(test_kobj_init);
module_exit(test_kobj_exit);

MODULE_AUTHOR(&quot;LoyenWang&quot;);
MODULE_LICENSE(&quot;GPL&quot;);

</code></pre>
<h3 id="42-makefile">4.2 Makefile</h3>
<pre><code>
ifneq  ($(KERNELRELEASE),)
obj-m:=test_kobject.o
else
KERDIR := /lib/modules/$(shell uname -r)/build
PWD:=$(shell pwd)
all:
    make -C $(KERDIR) M=$(PWD) modules
clean:
    rm -f *.ko *.o *.symvers *.cmd *.cmd.o modules.* *.mod.c
endif

</code></pre>
<ul>
<li><code>Makefile</code>没有太多好说的，注意<code>Tab</code>的使用，否则容易出错；</li>
</ul>
<h3 id="43">4.3 测试结果</h3>
<p><img alt="png" src="../../img/WechatIMG341.jpg" /></p>
<ul>
<li>
<p>在<code>/sys</code>目录下创建了<code>test_kobj</code>文件夹，在该文件夹下除了<code>name</code>和<code>value</code>外，还有一个<code>test_kobj_group</code>的子文件夹；</p>
</li>
<li>
<p>可以通过<code>cat/echo</code>的操作，来操作<code>name</code>和<code>value</code>，分别会调用到底层的<code>xxx_show</code>和<code>xxx_store</code>函数；</p>
</li>
<li>对着代码看这个图，一目了然；</li>
</ul>
<h3 id="44">4.4 更多例子</h3>
<ul>
<li>
<p><a href="https://mp.weixin.qq.com/s/P5PiKohwGujHJyxbyHDvLg">Linux 下添加自己的 sysfs 接口</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s/nYKSAcJ_8HjjaxB6hrOnVw">Linux 驱动 | 在驱动中创建 sysfs 接口</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s/KKy_sg-cNecJ0jzQzAHSsw">Linux 为什么有些驱动必须用 sysfs</a></p>
</li>
<li>
<ul>
<li>sysfs 可以将设备属性直接展示给用户空间,可以在控制台和 shell 脚本上直接和用户空间进行交互, 而 ioctl 需要编写个 c 程序才能运行。因此在这方面 sysfs 更合适。</li>
</ul>
</li>
</ul>
<h2 id="_5">五 参考文档</h2>
<ul>
<li><a href="https://mp.weixin.qq.com/s/WET4m1Nd2vpvojKjgmRkbw">linux 设备模型之 kset/kobj/ktype 分析</a></li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../7_three_object_of_block_device/" class="btn btn-neutral float-left" title="第七篇 块设备三大对象block_device、gendisk、hd_struct数据结构总结"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../9_io_uring/" class="btn btn-neutral float-right" title="第九篇 io_uring研究和总结">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../7_three_object_of_block_device/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../9_io_uring/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
